<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title></title>
    <style media="screen">
    body{
      margin:0px;
      text-align: center;
      background-color: black;
      color: #FAFAFA;

    }
    a {
      color: #FAFAFA;
    }
    .title {
      font-size: 16pt;
      text-decoration-style: dotted;
    }
    a:visited {
      color: #c0c0c0;
    }
      img,iframe {
        max-height: 70%;
        max-width: 70%;
        border: 1px dashed grey;
      }
      .header {
        position: fixed;
        width: 100%;
        top: 0px;
        opacity: 0.1;
        border-bottom: 1px solid grey;
        background-color: black;
      }
      .header:hover {
        opacity: 1;
      }
      .content {
        margin-top: 55px;
        width: 60%;
        margin-left: auto;
        margin-right: auto;
      }
      .reverse {
        display: flex;
        flex-direction: column-reverse;
      }
      hr{
        border: 1px dashed grey;
        width: 50%;
      }
      button,select,input {
        padding: 8px;
        font-size: 13pt;
      }
      .selftext {
        font-size: 15pt;
      }
    </style>
  </head>
  <body>
      <div class="header">
        <button type="button" id="pausefeed">Pause</button>
        <button type="button" id="nsfwswitch">Switch to NSFW</button>
        <button type="button" id="sortorder">Reverse Sort Order</button>
        <button type="button" name="button" id="audionotif">Audio Notif</button>
        <select id="subselect">
          <option value="">Subreddit</option>
          <option value="all">All</option>
        </select>
        <select id="sortby">
          <option value="">Sort By</option>
          <option value="new">new</option>
          <option value="hot">hot</option>
          <option value="controversial">controversial</option>
          <option value="top">top</option>
          <option value="rising">rising</option>
        </select>
        <input type="text" name="" placeholder="input subreddit & press enter" id="customsub"><br>
        <div id="paramstate">Current Settings: </div>

        <audio id="audiocontainer"><source id="audiosource" src="" type="audio/mp3"/></audio>

      </div>

    <div  id="reddit" class="content"></div>
    </div>
  </body>

  <script type="text/javascript">
  var audiofile = 'data:audio/mp3;base64,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'

  const postarr = [];
  var urlParams = new URLSearchParams(window.location.search);
  var paused = false;
  var bloburl = convertDataURIToBinary(audiofile);
  document.getElementById("audiosource").src = bloburl;

  function convertDataURIToBinary(dataURI) {
    var BASE64_MARKER = ';base64,';
    var base64Index = dataURI.indexOf(BASE64_MARKER) + BASE64_MARKER.length;
    var base64 = dataURI.substring(base64Index);
    var raw = window.atob(base64);
    var rawLength = raw.length;
    var array = new Uint8Array(new ArrayBuffer(rawLength));
    for(i = 0; i < rawLength; i++) {
      array[i] = raw.charCodeAt(i);
    }
    var blob = new Blob([array], {type : 'audio/mp3'})
    return URL.createObjectURL(blob);
  }

  function prependtodiv(data, divid, postid, array) {
    if(data) {
      if(!array.includes(postid)) {
        array.push(postid);
        if(array.length == 1500) {
          array.splice(0,200);
        }
        var div = document.getElementById(divid);
        div.innerHTML += data;
      }
    }
  }

  function isEmpty(myObject) {
      for(var key in myObject) {
          if (myObject.hasOwnProperty(key)) {
              return false;
          }
      }
      return true;
  }

  function generatemarkup(data) {
    if(data) {
      return `
        <div class="post">
        <a href="https://www.reddit.com${data.permalink}" target="blank" class="title">${data.title}</a><br><br>
        Author: <a href="http://reddit.com/user/${data.author}" target="blank">${data.author}</a> | Domain: ${data.domain} | Subreddit: <a href="http://www.reddit.com/r/${data.subreddit}" target="blank">${data.subreddit}</a> | ${timeConverter(data.created_utc)}<br>
        ${data.preview ? '<img src="'+data.preview.images[0].source.url+'"> <br>' : ''}
        ${data.selftext ? '<p class="selftext">'+data.selftext.substring(0,250) + '</p>': ''}
        <br><br><hr>
        </div>
      `;
    }
  }

  function timeConverter(UNIX_timestamp){
    var a = new Date(UNIX_timestamp * 1000);
    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    var year = a.getFullYear();
    var month = months[a.getMonth()];
    var date = a.getDate();
    var hour = a.getHours();
    var min = a.getMinutes();
    var sec = a.getSeconds();
    var time = date + ' ' + month + ' ' + year + ' ' + hour + ':' + min + ':' + sec ;
    return time;
  }

  if(urlParams.has('subreddit')) {
    var subreddit = urlParams.get('subreddit')
  } else {
    var subreddit = 'all'
  }

  if(urlParams.has('sortby')) {
    var subredditsort = urlParams.get('sortby');
  } else {
    var subredditsort = "new";
  }

  if(urlParams.has('nsfw') & urlParams.get('nsfw') == 'true') {
    var nsfwswitch = true;
    document.getElementById('nsfwswitch').innerHTML = "Switch to SFW";
  } else {
   var nsfwswitch = false;
  }

  if(urlParams.has('audionotif') & urlParams.get('audionotif') == 'true') {
    document.getElementById('audionotif').innerHTML = "Disable Audio"
    var audionotif = true;
  } else {
    var audionotif = false;
  }

  if(!window.location.search) {
    document.getElementById("paramstate").innerHTML += "No settings selected, using defaults.";
  }

  urlParams.forEach(function(value, key) {
    document.getElementById("paramstate").innerHTML += key + " = " + value + " | ";
  });

  document.getElementById('pausefeed').addEventListener("click", function(e) {
    e.preventDefault;
    if(!paused) {
      paused = true;
      document.getElementById('pausefeed').innerHTML = "Resume"
    } else {
      paused = false;
      document.getElementById('pausefeed').innerHTML = "Pause"
    }
  })

  document.getElementById('nsfwswitch').addEventListener("click", function(e) {
    e.preventDefault;
    if(!nsfwswitch) {
      window.location.href="?nsfw=true&subreddit="+subreddit+"&sortby="+subredditsort+"&audionotif="+audionotif
    } else {
      window.location.href="?nsfw=false&subreddit="+subreddit+"&sortby="+subredditsort+"&audionotif="+audionotif
    }
  });

  document.getElementById('subselect').addEventListener("change", function(e) {
    window.location.href="?nsfw="+nsfwswitch+"&subreddit="+document.getElementById('subselect')[document.getElementById('subselect').selectedIndex].value+"&sortby="+subredditsort+"&audionotif="+audionotif
  });

  document.getElementById('sortorder').addEventListener("click", function(e) {
    document.getElementById("reddit").classList.toggle("reverse");
  });

  document.getElementById('sortby').addEventListener("change", function(e) {
    window.location.href="?nsfw="+nsfwswitch+"&subreddit="+subreddit+"&sortby="+document.getElementById('sortby')[document.getElementById('sortby').selectedIndex].value+"&audionotif="+audionotif
  });

  document.getElementById('customsub').addEventListener("keyup", function(e) {
    if(e.keyCode == 13) {
      window.location.href="?nsfw="+nsfwswitch+"&subreddit="+document.getElementById("customsub").value+"&sortby="+subredditsort+"&audionotif="+audionotif
    }

  });

  document.getElementById('audionotif').addEventListener('click', function(e) {
    if(!audionotif) {
      window.location.href="?nsfw="+nsfwswitch+"&subreddit="+subreddit+"&sortby="+subredditsort+"&audionotif=true"
    } else {
      window.location.href="?nsfw="+nsfwswitch+"&subreddit="+subreddit+"&sortby="+subredditsort+"&audionotif=false"
    }
  })

  var timer =  window.setInterval(function() {
    if(!paused) {
      fetch('https://www.reddit.com/r/'+subreddit+'/'+subredditsort+'.json?raw_json=1&limit=1000').then((raw) => raw.json()).then(function(res) {
        return res.data.children;
      }).then(function(children) {
        for (var i = 0; i < children.length; i++) {
          if(!children[i].data.over_18 & !nsfwswitch) {
            !postarr.includes(children[i].data.id) & audionotif ? document.getElementById("audiocontainer").play() : null;
            prependtodiv(generatemarkup(children[i].data), "reddit", children[i].data.id, postarr)
          }
          if(children[i].data.over_18 & nsfwswitch) {
            !postarr.includes(children[i].data.id) & audionotif ? document.getElementById("audiocontainer").play() : null;
            prependtodiv(generatemarkup(children[i].data), "reddit", children[i].data.id, postarr)
          }
        }
      }).catch(function(error) {
        console.log(error);
      })
    }
  }, 2000);

  fetch('https://www.reddit.com/r/popular.json').then((raw) => raw.json()).then(function(res) {
    return res.data.children;
  }).then(function(children) {
    for (var i = 0; i < children.length; i++) {
      document.getElementById('subselect').innerHTML += '<option value="'+children[i].data.subreddit+'">'+children[i].data.subreddit+'</option>'
    }
  }).catch(function(error) {
    console.log(error);
  })
</script>

</html>
